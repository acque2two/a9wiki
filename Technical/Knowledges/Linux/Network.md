# Linux/Network
すべて当該サブコマンドの次に`help`サブコマンドを追加することでヘルプを参照可能

# L3 ( IP / IPv6 )
## IP/IPv6アドレス
* `ip addr`
* `ip addr show dev enp0s25`
* `ip addr add dev enp0s25 192.168.1.2/24`
* `ip addr del dev enp0s25 192.168.1.2/24`

#### コマンド解説
* `address`, `a`
  - L3アドレスへのコマンドであることを指定するサブコマンド

### IPを確認する
`ip address show [dev enp0s25] [master virbr0] [type veth] [up]`

#### コマンド解説
* `show`, `s`
  - IPアドレスの確認を行うことを指定するサブコマンド
* `dev enp0s25`
  - どのデバイスのIPアドレスを表示するか指定するサブコマンド
  - サブコマンドの後にデバイス名(例: enp0s25, eth0, wlan0)を指定する
* `master virbr0`
  - ブリッジ配下のインターフェイスに指定されているIPを確認できるコマンド
  - 普通ここにIPが指定されているとそのIP帯での通信が不可能になる
* `type veth`
  - IPアドレスの確認を行うデバイスを指定する
  - `veth`以外にも`bridge`, `vlan`, `gre`等、`ip`コマンドで指定できるすべてのI/Fタイプを指定可能
* `up`
  - L2(1)レベルでリンクアップしているものについてIPを表示する

### IPを追加・設定する
`ip address add dev enp0s25 192.168.1.2/24 [valid_lft 300 label]`

#### コマンド解説
* `add`, `a`
  - IPアドレスの追加を行うことを指定するサブコマンド
* `dev enp0s25`
  - 指定したIPアドレスをどのデバイスに割り当てるか指定するサブコマンド
  - サブコマンドの後にデバイス名(例: enp0s25, eth0, wlan0)を指定する
* `valid_lft 300`
  - そのIPが有効な時間を秒で指定する
  - この時間が過ぎると設定されたIPアドレスは消失する
  - `forever`指定で自動で消失しないようにできる
* `label`
  - このIPをメインで使用するIPとして指定する
  - `ifconfig`のような「デバイスごとのIPを一つしか表示できないアプリケーション」で表示されるIPを指定するのに使う

### 割当られているIPを削除する
`ip address delete dev enp0s25 192.168.1.2/24`

#### コマンド解説
* `delete`, `d`
  - IPアドレスの削除を行うことを指定するサブコマンド
* `dev enp0s25`
  -どのデバイスの指定したIPアドレスを削除するか指定するサブコマンド
  - サブコマンドの後にデバイス名(例: enp0s25, eth0, wlan0)を指定する

## 経路情報
* `ip r`
* `ip route`
* `ip route list`
* `ip route add 172.16.0.0/16 via 192.168.1.1`
* `ip route add default via 192.168.1.1`
* `ip route delete 192.168.11.0/24 via 192.168.1.1`
* `ip route replace 192.168.11.0/24 via 192.168.2.1`

#### コマンド解説
* `route`, `r`
  - 経路情報へのコマンドであることを指定するサブコマンド

### 経路情報を確認する
* `ip r`
* `ip route`
* `ip route list [match 192.168.1.1]`
* `ip route show [match 192.168.1.1]`

#### コマンド解説
* `list`, `show`
  - 経路情報の確認を行うことを明示的に指定するサブコマンド
  - 省略した場合も確認を行うことができる
* `match`
  - 指定したIPアドレスが該当する経路情報を取得する
  - 最もプレフィックス値が大きい（ネットワークの小さい）ものを使う
    + 同じ値の場合はメトリック値が小さいものを使う


### 経路情報を追加する
* `ip route add 192.168.2.0/24 [via 192.168.1.1] [metric 500] [type unicast] [proto static] [src 192.168.1.2] [dev enp0s25]`

#### コマンド解説
* `add`
  - 経路情報の追加を行うことを指定するサブコマンド
* `192.168.2.0/24`
  - 宛先経路を指定する
  - この条件に合致したものはこの行で指定するルールに従ってルーティングされる
    + 複数合致した場合は最もプレフィックス値が大きい(ネットワークが小さい)ものを使う
  - `default`を指定した場合、`0.0.0.0/0`として扱われる（デフォルトゲートウェイになる)
* `via 192.168.1.1`
  - 同一ネットワークではない場合のパケットの転送先を指定する
    + つまりネクストホップアドレス（ルータのIP）
  - 自分が所属しているネットワークのIPでないと受け付けてもらえない
    + 例えば192.168.1.0/24ネットワークにしか所属していないのに192.168.2.1をviaに指定することはできない
  - 指定しなかった場合、直接接続されている（同じネットワークに所属している）ものとして扱われる
* `metric 500`
  - この経路情報のメトリック値を設定する
    + 同じ経路への経路情報でかつ同じプレフィックス値だった場合の優先度として使われる
  - 数値が小さいほうが優先度が高くなる
  - 意図的に優先順位を下げることでフローティングルートとして利用できる
    + 優先度の低いI/Fや経路が利用できなくなった場合に浮き上がってくるように使えるようになる経路のこと
* `type unicast`
  - 経路での通信時のタイプを指定する
    - unicast指定するとARPでMACアドレスを確認してから1:1通信を行う
    - broadcast指定するとこの経路での通信は常にBroadcastとして通信される(宛先MACアドレスが`FF:FF:FF:FF:FF:FF`になる)
    - unreachable指定すると強制的に当該PCへの経路がなくなったように扱われる(PingコマンドでNo route to host扱いになる)
    - prohibit指定するとなんか通信できなくなる(アクセス制御に使う？）
* `proto static`
  - 経路の追加元を指定できる
    - kernelにするとカーネルが経路を追加したように扱える
    - staticにすると自分で静的経路を追加したことになる
      - 同一プレフィックス、同一メトリックの場合kernelより優先度が下がる
    - bootにすると起動時に自動で経路が追加された扱いになる
      - 同一（略）の場合staticより優先度が下がる
* `src 192.168.2.1`
  - 経路を利用する発信元IPを指定できる
    + 指定した発信元IPで発信されるパケットではないパケットの場合ルールに合致しなくなる
    + 指定する必要はないが、指定することで一部のワークロードで便利だったりする
      * arpspoof攻撃中に自分のIPだけでの利用経路を指定してそれ以外の経路を削除することでよりレベルの高い嫌がらせが可能になる
    + VYOSのようなルータOSの場合に攻撃を受けていない回線でSSH接続をするといったことが可能になる
* `dev enp0s25`
  - 経路を利用するI/Fを指定できる
    - 宛先が利用できてもデバイスが一致しなければ適用されない
    - 無線LANと有線LANで同じネットワークに接続されている際にmetricと一緒に利用して有線LANを優先させるようにすることが可能

### 近傍・隣接デバイス ( Neighbors / ARP )
* `ip n`
* `ip neigh`
* `ip neighbor`
* `ip neigh show to 192.168.1.1`
* `ip neigh add 192.168.1.1 lladdr 22:44:66:88:AA:CC`

#### コマンド解説
* `n` `neigh` `neighbor`
  - 近傍・隣接デバイス情報テーブルへのコマンドであることを指定するサブコマンド

### 隣接デバイス情報テーブルを確認する
* `ip neigh show [ to 192.168.1.1 ] [ dev enp0s25 ]`
    - IPv6だとNeighbor discovery、IPv4だとARPで取得したデータと手動で設定したデータが表示される

#### コマンド解説
* `show` `list`
  - 隣接デバイス情報テーブルの確認を行うことを明示的に指定するサブコマンド
  - 省略した場合も確認を行うことができる
* `to 192.168.1.1`
  - 隣接デバイス情報テーブルから指定したIPアドレスに関連・該当するもののみを出力できる
* `dev enp0s25`
  - 隣接デバイス情報テーブルを利用するI/Fを指定できる
    - 宛先L33アドレスが利用できてもデバイスが一致しなければ適用されない
    - 無線LANと有線LANで同じネットワークに接続されている際にmetricと一緒に利用して有線LANを有線させるようにすることが可能

### 隣接デバイス情報テーブルに情報を追加する
* `ip neigh add 192.168.1.1 lladdr 22:44:66:88:AA:CC [ dev enp0s25 ]`

#### コマンド解説
* `add`
  - 隣接デバイス情報テーブルへ情報の追加を行うことを明示的に指定するサブコマンド
* `192.168.1.1 lladdr 22:44:66:88:AA:CC`
  - IPアドレスに関連付けるL2アドレス(MACアドレス)を指定する
* `dev enp0s25`
  - 隣接デバイス情報テーブルに追加する情報を利用するデバイス名を指定する

## Sublinks